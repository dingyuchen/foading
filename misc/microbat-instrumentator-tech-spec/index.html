<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/foader/styles.cd26d764ef9aba2e9aa1.css" id="gatsby-global-css">.popover{position:relative;max-width:16rem;box-shadow:0 10px 15px -3px var(--shadow),0 4px 6px -2px rgba(0,0,0,.05);padding:1rem;border:1px solid var(--separator);border-radius:.5rem;background-color:var(--references-bg);max-height:16rem;overflow:hidden}.popover.no-max-width{max-width:90vw}.popover.with-markdown{font-size:.875rem}.popover h1{margin:0;padding:0;font-size:1rem}.popover ul{padding-left:1rem}.popover .more-content-blind{height:4rem;position:absolute;background:transparent;background:linear-gradient(0,var(--references-bg),var(--references-bg-80) 50%,var(--references-bg-0));top:12rem;width:100%;left:0}.tippy-box[data-animation=shift-away][data-state=hidden]{opacity:0}.tippy-box[data-animation=shift-away][data-state=hidden][data-placement^=top]{-webkit-transform:translateY(10px);transform:translateY(10px)}.tippy-box[data-animation=shift-away][data-state=hidden][data-placement^=bottom]{-webkit-transform:translateY(-10px);transform:translateY(-10px)}.tippy-box[data-animation=shift-away][data-state=hidden][data-placement^=left]{-webkit-transform:translateX(10px);transform:translateX(10px)}.tippy-box[data-animation=shift-away][data-state=hidden][data-placement^=right]{-webkit-transform:translateX(-10px);transform:translateX(-10px)}.reference{text-decoration:none}.reference:hover{color:var(--references-highlight)}.reference>div{padding-top:.5rem;padding-bottom:.5rem}.reference>div>p{margin:0;font-size:.875rem}.reference>div>ul{margin:0}.references-block{color:var(--references-text);padding:1rem;margin:1rem 0;border-radius:.5rem;background-color:var(--references-bg);transition:background-color .3s ease,color .3s ease}.references-block>div{margin-bottom:1rem}.references-block>hr{margin-left:auto;margin-right:auto;width:8rem}.references-block a{color:var(--references-text);transition:color .3s ease}.references-block>p:last-child{margin-bottom:0}.note-container{background:var(--note-bg);transition:background .3s ease}.note-container:first-child{border-left:none}.note-container .note-content,.note-container .obstructed-label{transition:opacity 75ms linear}.note-container .obstructed-label{display:block;color:var(--text);text-decoration:none;font-size:17px;line-height:40px;font-weight:500;-webkit-writing-mode:vertical-lr;-ms-writing-mode:tb-lr;writing-mode:vertical-lr;-webkit-text-orientation:sideways;text-orientation:sideways;margin-top:36px;top:0;bottom:0;left:0;position:absolute;background-color:transparent;width:40px;overflow:hidden;opacity:0;transition:color .3s ease;pointer-events:none}.note-container.note-container-highlighted{background:var(--references-bg);transition:background .3s ease}.note-content img{max-width:100%}@media screen and (max-width:800px){.note-container{padding:16px;width:100%;overflow-y:auto}}@media screen and (min-width:801px){.note-container{transition:box-shadow .1s linear,opacity 75ms linear,-webkit-transform .2s cubic-bezier(.19,1,.22,1);transition:box-shadow .1s linear,opacity 75ms linear,transform .2s cubic-bezier(.19,1,.22,1);transition:box-shadow .1s linear,opacity 75ms linear,transform .2s cubic-bezier(.19,1,.22,1),-webkit-transform .2s cubic-bezier(.19,1,.22,1);flex-shrink:0;width:625px;max-width:625px;top:0;position:sticky;flex-grow:1;border-left:1px solid var(--separator);padding:0}.note-content{overflow-y:auto;height:100%;padding:32px}.note-container-overlay{box-shadow:0 0 15px 3px var(--shadow)}.note-container-obstructed .note-content{opacity:0}.note-container-obstructed .obstructed-label{opacity:1;pointer-events:all}}.dark-mode-toggle{cursor:pointer;-webkit-transform:scale(.6);transform:scale(.6)}.dark-mode-toggle input{display:none}.dark-mode-toggle input+div{border-radius:50%;width:36px;height:36px;position:relative;box-shadow:inset 16px -16px 0 0 #fff;-webkit-transform:scale(1) rotate(-2deg);transform:scale(1) rotate(-2deg);transition:box-shadow .5s ease 0s,-webkit-transform .4s ease .1s;transition:box-shadow .5s ease 0s,transform .4s ease .1s;transition:box-shadow .5s ease 0s,transform .4s ease .1s,-webkit-transform .4s ease .1s}.dark-mode-toggle input+div:before{content:"";width:inherit;height:inherit;border-radius:inherit;position:absolute;left:0;top:0;transition:background .3s ease}.dark-mode-toggle input+div:after{content:"";width:8px;height:8px;border-radius:50%;margin:-4px 0 0 -4px;position:absolute;top:50%;left:50%;box-shadow:0 -23px 0 var(--link),0 23px 0 var(--link),23px 0 0 var(--link),-23px 0 0 var(--link),15px 15px 0 var(--link),-15px 15px 0 var(--link),15px -15px 0 var(--link),-15px -15px 0 var(--link);-webkit-transform:scale(0);transform:scale(0);transition:all .3s ease}.dark-mode-toggle input:checked+div{box-shadow:inset 32px -32px 0 0 #fff;-webkit-transform:scale(.5) rotate(0deg);transform:scale(.5) rotate(0deg);transition:box-shadow .2s ease 0s,-webkit-transform .3s ease .1s;transition:transform .3s ease .1s,box-shadow .2s ease 0s;transition:transform .3s ease .1s,box-shadow .2s ease 0s,-webkit-transform .3s ease .1s}.dark-mode-toggle input:checked+:before{background:var(--link);transition:background .3s ease .1s}.dark-mode-toggle input:checked+:after{-webkit-transform:scale(1.5);transform:scale(1.5);transition:-webkit-transform .5s ease .15s;transition:transform .5s ease .15s;transition:transform .5s ease .15s,-webkit-transform .5s ease .15s}.graph-button{border:0;background:none;cursor:pointer}.graph-button svg g{stroke:var(--link)}.searchWrapper{position:relative;display:block}.inputWrapper{position:relative;color:var(--text)}.inputWrapper .searchIcon{position:absolute;fill:var(--link);left:2px;height:34px;padding:2px 2px 0;pointer-events:none}.inputWrapper input{color:var(--text);font-size:1rem;border:none;height:36px;padding-left:28px;background-color:var(--note-bg);transition:all .3s ease-in-out;width:28px}.inputWrapper input:focus{outline:none;width:100%}.results{-webkit-padding-start:0;padding-inline-start:0;position:absolute;display:block;top:100%;right:0;width:500px;max-height:50vh;background:var(--note-bg);box-shadow:-5px -5px 15px -3px var(--shadow),0 4px 6px -2px rgba(0,0,0,.05);overflow-y:auto;border-radius:8px}.results li{display:block;text-decoration:none;cursor:pointer;padding:16px 24px;border-bottom:1px solid var(--separator)}.results li:hover{background:var(--references-bg)}.results li .title{color:var(--text)}.results li .excerpt{color:var(--references-text)}@media screen and (max-width:600px){.results{right:-85px;width:calc(100vw - 40px)}}.lds-dual-ring:after{content:" ";left:calc(50% - 32px);position:relative;display:block;width:64px;height:64px;margin:8px;border-radius:50%;border-color:var(--separator);border-left:6px solid transparent;border-bottom:6px solid var(--separator);border-right:6px solid transparent;border-top:6px solid var(--separator);-webkit-animation:lds-dual-ring 1.2s ease-in-out infinite;animation:lds-dual-ring 1.2s ease-in-out infinite}@-webkit-keyframes lds-dual-ring{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}to{-webkit-transform:rotate(1turn);transform:rotate(1turn)}}@keyframes lds-dual-ring{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}to{-webkit-transform:rotate(1turn);transform:rotate(1turn)}}header{width:100%;min-height:57px;z-index:5;background-color:var(--note-bg);border-bottom:1px solid var(--separator);display:flex;justify-content:space-between;align-items:center;padding:10px 32px;flex-wrap:wrap;transition:background-color .3s ease}header>a{font-weight:700;color:var(--text);text-decoration:none;transition:color .3s ease}header .controls{display:flex}html{font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;line-height:1.5}body.light-mode{--main-bg:#fafafc;--note-bg:#fff;--text:#1a202c;--separator:#e2e8f0;--shadow:rgba(0,0,0,0.1);--link:#3182ce;--references-bg:#ebf4ff;--references-bg-80:rgba(235,244,255,0.8);--references-bg-0:rgba(235,244,255,0);--references-text:#718096;--references-highlight:#4a5568}body.dark-mode{--main-bg:#000;--note-bg:#0a0d11;--text:#fafafc;--separator:#252525;--shadow:hsla(0,0%,100%,0.1);--link:#3da1ff;--references-bg:#17181a;--references-bg-80:rgba(23,24,26,0.8);--references-bg-0:rgba(23,24,26,0);--references-text:#8c9fbb;--references-highlight:#b3cbf0}body{background-color:var(--main-bg);color:var(--text);margin:0;padding:0;height:100vh;transition:background-color .3s ease,color .3s ease}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,p,pre{margin:0}*,:after,:before{box-sizing:border-box}h1,h2,h3{font-weight:700}hr{margin-top:1rem;margin-bottom:1rem;border:solid var(--separator);border-width:1px 0 0;box-sizing:content-box;height:0;overflow:visible}a{color:var(--link);text-decoration:underline;transition:color .3s ease}a:hover{text-decoration:none}h1{font-size:1.875rem;margin-top:1rem}h1,p{margin-bottom:1rem}.layout{height:100vh;display:flex;flex-direction:column}.note-columns-scrolling-container{display:flex;overflow-x:auto;overflow-y:hidden;flex-grow:1}.note-columns-container{display:flex;flex-grow:1;transition:width .1s cubic-bezier(.19,1,.22,1)}@media screen and (max-width:800px){.note-columns-container{width:unset!important}}.overlay{z-index:98;position:fixed;top:0;right:0;bottom:0;left:0;display:flex;align-items:center;justify-content:center;height:100%;width:100%;background-color:var(--shadow);-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px)}.modal{z-index:99;position:fixed;border-radius:8px;background-color:var(--main-bg);box-shadow:-5px -5px 15px -3px var(--shadow),0 4px 6px -2px rgba(0,0,0,.05)}.modal-close,.modal-scale{position:absolute;top:0;right:0;padding:5px;border:0;background:none;color:var(--text);cursor:pointer}.modal-close svg,.modal-scale svg{width:20px;height:20px}.modal-close path,.modal-scale path{fill:currentColor}.modal-scale{right:30px}.modal-minimized .modal-close svg,.modal-minimized .modal-scale svg{width:15px;height:15px}.modal-minimized .modal-scale{right:25px}.modal-body{height:100%;width:100%}.modal-body .node,.modal-body .text{cursor:pointer}</style><meta name="generator" content="Gatsby 2.32.13"/><link as="script" rel="preload" href="/foader/component---node-modules-gatsby-theme-garden-src-templates-local-file-js-7cdfb5d1f36d324336f7.js"/><link as="script" rel="preload" href="/foader/styles-407fe62976dc5310c43e.js"/><link as="script" rel="preload" href="/foader/app-27801529279600ddbc18.js"/><link as="script" rel="preload" href="/foader/framework-06f646d936b841f99ebd.js"/><link as="script" rel="preload" href="/foader/webpack-runtime-c236c025df4c874ab705.js"/><link as="fetch" rel="preload" href="/foader/page-data/misc/microbat-instrumentator-tech-spec/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/foader/page-data/sq/d/2098632890.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/foader/page-data/sq/d/2221750479.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/foader/page-data/sq/d/2468095761.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/foader/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="layout"><header><a href="/foader/"><h3>Foam</h3></a><div class="controls"><div class="searchWrapper" role="combobox" aria-expanded="false" aria-haspopup="listbox" aria-labelledby="downshift-44-label"><div class="inputWrapper"><svg class="searchIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M23.111 20.058l-4.977-4.977c.965-1.52 1.523-3.322 1.523-5.251 0-5.42-4.409-9.83-9.829-9.83-5.42 0-9.828 4.41-9.828 9.83s4.408 9.83 9.829 9.83c1.834 0 3.552-.505 5.022-1.383l5.021 5.021c2.144 2.141 5.384-1.096 3.239-3.24zm-20.064-10.228c0-3.739 3.043-6.782 6.782-6.782s6.782 3.042 6.782 6.782-3.043 6.782-6.782 6.782-6.782-3.043-6.782-6.782z"></path></svg><input type="text" aria-autocomplete="list" aria-labelledby="downshift-44-label" autoComplete="off" value="" id="downshift-44-input" placeholder="Search..."/></div></div><button title="Show Graph visualisation" aria-label="Show Graph visualisation" class="graph-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20"><g fill="none" stroke-width="2"><circle cx="11.733" cy="3.181" r="1.902"></circle><circle cx="16.864" cy="10.861" r="1.902"></circle><circle cx="7.47" cy="16.822" r="1.902"></circle><circle cx="3.046" cy="6.275" r="1.902"></circle><circle cx="9.372" cy="10.861" r="1.902"></circle><line x1="11.635" x2="14.655" y1="10.861" y2="10.861"></line><line x1="10" x2="10.895" y1="8.959" y2="5.573"></line><line x1="7.47" x2="4.5" y1="9.68" y2="7.5"></line><line x1="8.25" x2="8.809" y1="14.92" y2="13.088"></line></g></svg></button><label class="dark-mode-toggle" aria-label="Activate dark mode" title="Activate dark mode"><input type="checkbox" checked=""/><div></div></label></div></header><div class="note-columns-scrolling-container"><div class="note-columns-container" style="width:1250px"><div class="note-container   " style="left:0;right:-585px"><div class="note-content"><h1 id="microbat-tech-spec">Microbat Tech Spec</h1><p>This document outlines the program architecture and proposed improvements to the instrumentator, and also certain areas of storage.</p><h2 id="instrumentator">Instrumentator</h2><p>In order to extend the capabilities of Microbat, and to allow for new developers to onboard onto the project faster, I believe it is necessary for the codebase to undergo some restructuring in order to improve explainability and reduce side effects.</p><p>As the first step in incremental refactoring, let&#x27;s refactor <code>ExecutionTracer</code> and related classes.</p><h3 id="the-instrumentation-process">The Instrumentation Process</h3><p>The instrumentation process as I understand:</p><pre><code>@startuml
Premain -&gt; Agent : new
Agent -&gt; Premain
Premain -&gt; Agent : startup()
Agent -&gt; Agent : startup()
Agent -&gt; Premain
Premain -&gt; Agent : getTransformer()
Agent -&gt; Premain
Premain -&gt; Instrumentation : inst.addTransformer
@enduml
</code></pre><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:363px">
      <a class="gatsby-resp-image-link" style="display:block" href="/foader/foader/static/600cf6526c612d8b3984c9b9fa558e37/4e786/2021-08-08-18-38-34.png">
    <span class="gatsby-resp-image-background-image" style="padding-bottom:83.57142857142857%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAAsTAAALEwEAmpwYAAAChElEQVQ4y4VSbW+bMBDm//+HVduaZF+3D9O6TdPUNa3adA0ECgES3kICBLCB8A62MwPVlGyTZp0Ozr7Hzz3nY4D26Bs3gXG3V74Da33sF2kR1B73xjTQfvgKHxlsYN74+q1vTH19utengf5jLz8xFv9l8XPCzd5x09fq0+0APrbIWny6u75g799KN58t4Rv3OGIfJuxswj6M5/dj/nG0uP7ApCEAth0Y5t6ykijqaAmhPoMQbLd0Pw5BBmBo29BxQtMC/Q+wt9DzGNIz5dFBEaU0jFBeNmneZgUu68oDBOHjyaJyCCa/Q4YG5EgOsll7kKQlirMaJNSqIDqoG1TVQy2kAxFUVbhtyRF3IcbMUGTqhaauG7ruuS6ix7g7w3WDG3TKjOv2tBZm+BRhvDdtRzND26njtEky6hNJx+3/wJQcldXx79WirWZIHC+LEoSQblAVBKFzZqqgbsiLsr4fvUNZAflV7oE8iIYu4aZTdALusw+y1YQJLiqUlTgrKQznVdPXP9w+ZP/JPDQs8UORW2hLRRHElbjUZZVa4YHj+VP9mzlaGrG5K3yYuQG13Ie5F6ZLk8o5BaOyJu2pZtLdlLk+9IMkjj3HjWEEgjACIIIQNe0ZczckuG9J16CXCYs9sFlbm5WuicuNujZk1VJ1U1yVIMVF3aZle6ioJeJZLUy6XeXusnTlypGKYP8yhghXrtb4SrYRYkvPaI4j5s4yswTqc08uXOmw1RhbvHoWxvxiws8u1vNpXxMhdbt5/jibvRLYN8rt1Vb6+iyMeG4scGOeHS3ml9LiUpy+Z6Cl7WTOXQk7cb7fWAMxhQNjZUvz3ZJ1tTXc6F2OyjtKZ64qODK3VaRf+0+zfg4hcZIAAAAASUVORK5CYII=&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="2021 08 08 18 38 34" title="2021 08 08 18 38 34" src="/foader/static/600cf6526c612d8b3984c9b9fa558e37/4e786/2021-08-08-18-38-34.png" srcSet="/foader/static/600cf6526c612d8b3984c9b9fa558e37/0d3e1/2021-08-08-18-38-34.png 140w,/foader/static/600cf6526c612d8b3984c9b9fa558e37/6b1e2/2021-08-08-18-38-34.png 281w,/foader/static/600cf6526c612d8b3984c9b9fa558e37/4e786/2021-08-08-18-38-34.png 363w" sizes="(max-width: 363px) 100vw, 363px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
  </a>
    </span></p><ol><li><code>Agent</code> handles setting up the <code>ExecutionTracer</code> </li><li><code>ExecutionTracer</code> methods are called by transforming classes (with <code>TraceTransformer</code>) and adding hooks to trigger method calls</li></ol><h3 id="proposed-change-1-to-executiontracer">Proposed Change 1 to ExecutionTracer</h3><p>Since the <code>threadId</code> can only be exposed by a call to the global <code>Thread.currentThread().getId()</code>, currently is it being called within the hook and then delegated to the corresponding tracer in <code>rtStore.get(long id)</code>.</p><p>However it is quite hard to reason about the behavior of <code>ExecutionTracer</code>, since it has a cyclic dependency on with <code>ExecutionTracerStore</code>, which is the concurrent trace manager.</p><p>Since keeping <code>ExecutionTracer</code> to handle more than 1 thread will generalize to single-threaded programs, we should redefine the program as follows:</p><pre><code>@startuml
class ExecutionTracer
class TracerStore
class TraceRecorder

ExecutionTracer *-- TracerStore 
TracerStore o-- TraceRecorder
@enduml
</code></pre><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:149px">
      <a class="gatsby-resp-image-link" style="display:block" href="/foader/foader/static/283a23c29fe0250a837d8286098a8e18/d371d/2021-08-08-18-58-07.png">
    <span class="gatsby-resp-image-background-image" style="padding-bottom:190.71428571428572%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAmCAIAAABLWSz8AAAACXBIWXMAAAsTAAALEwEAmpwYAAAE4UlEQVRIx7VVW1PbRhT2f+x7njt96kvbpzz0ITPpTCdNQxJIIPgCwRjZBHzBODaSb7KN5TuW73eCceKLJMs3SbtSVrYhENIknWl3Pp35dM4eHa20Zz+NxE+4XGlSq0+qdS5fZukSmysxdJG94gvL5coqn4PJFIQeqyiKhi83emEzTezSri2hTQCWBAwJ2ZDY9UOGFHt+mSGlfgAROAiCflAZRmYNF2XCBFnWzOqtpHP715X7j00rVGAnHNVncuYwtf2u4z72rEZi22kaQ7dU0pg6w+jCm1jaVMxiHq12OJmqyXGb/r724ap9PRPey2T34kljIrVbazhw70b6bI+K71Rr9tY7F3KmMqZMztIsWb0GAz+dafhqk83YS9RBicTAMKLApCwlVCvEFCWlAJVDMa7eAhSKIydggp6NTX4203CFWsuyOQhben6s4zW1T4xt3HiJ7yK0PTvXXL1VYez49tp2vWvlxUgUNFy+2vFsj8rHw6ydp+18zrFE/mjcwvnC0S0nQtHJUZa3T9d4QdBILJ/a3z/RvfLqdYReu4RBh6+/PP7hR/z5KrGlJ3Ta65DXoDtZf+l8bZpJogb9rslM7LPDAccvwQ6Z0bjb/kDe+/19/YIZTwY3oxzf5/jxdKrIikaRZRV3hgzAuHE5Z1+ILoZmOfWzoShQlIblcxSCEMpfGp+Sv1BZAnz13eK536j83yePahfflSxDGQgyFFULZhAIUBqLLN2EkgKmAMyA6kSYQjTzU/LiwX0qzpy62TDOxbzDTIBPB5iEt0e62JSfS/n5TABZJunjksSFzy+K4KryPJmhgllq74XhUTRo5If+LkNMhYgAohMhzPL+bh/nRgHkEWEkvLPRrLYWy0GVIWK9E3wLe37vwc9bdm0hbCKIdYf1ievomcP25MT90mT8Yx/70+N64bD/7V5/2qqfL5MXldl4KEuZdbaNKIkpMAWV9AxQAogBJSErKUlOCJCaSajPziKmzXqlcatyBz9hE/td3x6XtLL0EXtm5+ijBdisg6Mdc3I0KR37nq806rdfu+109cPYMONg4odM9IChkD0cUIjM+RyD6OEoafOvPGk2zm9XJnzlY0PFY6x4duZWRcttrF5xhLLb2CR2nY8e3UxW1yyMp4lgNIIHTwlShS8UcRK0wRFx4Iif4uTCjybEItHxZHz1wf5ph0HI0bWvtNSt7Xm7ZdBukxZ7+25X/YvGUP7HrkLL+xzoEkS+Mj8MALg74Xtasv3tynylOSpVZrU6X6peaVqZOStcekgkd6roXUmc6s8W+HJz8SE0qFe7PvsFZU5Ydb30IdI0qbvUNJkJKWxIHpCgF4D9IILUDSjTaNnxupYtqclQhB3coTtc/enhL8GwJZfBoilV03LFg1B068D+OJE2FSrWbMGSymIuz1q6aCGxtWQgOj8MRHjptumsa79tPPAHMaaDl+v2WGInk8Xo/H4kupXJmvPFN2e0akNhfbFujVk306HY/LWnYHDqfl9wpHATW32LpEzVNDjXNKRysqp1S45CSAMVOufcTiwrS3LTbOoGTX0/9iGA3dS0a4m7xoXH2CfNp0//SoXj8zUL8MKG8XnbMOsYfqZpd4DEUKi/TeqeoS5a/qpz1C36V4RB+z3wbesPV54V6PwyGUB5MBzdlLKvg+VHAKgH6Ee6MtPVrA9M5wAAAABJRU5ErkJggg==&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="2021 08 08 18 58 07" title="2021 08 08 18 58 07" src="/foader/static/283a23c29fe0250a837d8286098a8e18/d371d/2021-08-08-18-58-07.png" srcSet="/foader/static/283a23c29fe0250a837d8286098a8e18/0d3e1/2021-08-08-18-58-07.png 140w,/foader/static/283a23c29fe0250a837d8286098a8e18/d371d/2021-08-08-18-58-07.png 149w" sizes="(max-width: 149px) 100vw, 149px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
  </a>
    </span></p><pre><code class="language-java">class ExecutionTracer {
    private final TracerStore store = new TracerStore()
    public void _exampleHook(args) {
        long threadId = Thread.currentThread().getId();
        store.get(threadId).record(args);
    }
}

class TracerStore {
    private List&lt;TraceRecorder&gt; recorders = new ArrayList&lt;&gt;();
}
</code></pre><p>Ideally, <code>ExecutionTracer</code> should not be accessed statically.
The instrumentation process should somehow point a given <code>ExecutionTracer</code> instance.</p><p>I believe this is done in the <code>TracerMethods.java</code> file, which points to the <code>IExecutionTracer</code> interface.
It is unclear whether it is possible to use an object rather than a static class to be the implementing instance.</p><h3 id="proposed-change-2-to-executiontracer">Proposed Change 2 to ExecutionTracer</h3><p>This change pertains to improving the recording abilities of Microbat.
Since out-of-memory (OOM) errors are a possibility, we have to keep a cache of steps recorded and evict all of them once a certain threshold is hit.</p><p>This also means that there is no utility in storing the complete trace in each <code>ExecutionTracer</code>, and will also be no longer possible to construct all the trace relations during the instrumentation phase.</p><ul class="contains-task-list"><li class="task-list-item"><input type="checkbox" disabled=""/> <code>ExecutionTracer</code> needs to keep track of <code>runId</code></li><li class="task-list-item"><input type="checkbox" disabled=""/> <code>TraceRecorder</code>s will keep <code>traceId</code> or <code>threadId</code>x<code>runId</code> as identifier</li><li class="task-list-item"><input type="checkbox" disabled=""/> <code>ExecutionTracer</code> may have to initialize and establish a connection to <code>Apollo GraphQL</code><ul class="contains-task-list"><li class="task-list-item"><input type="checkbox" disabled=""/> <!-- -->reference to connection will be passed into the constructor for <code>TraceRecorder</code>s, with each call sending an <code>INSERT</code> statement to the <code>Apollo Server</code> (if necessary)</li></ul></li></ul><h4 id="relationship-construction">Relationship Construction</h4><p>With this change, it would also mean that the <code>FileRecorder</code> and <code>FileRetriever</code> would be deprecated, since large traces will not exist fully in memory and it will not be possible to serialize it.</p><p>To continue supporting the local storage formats, we might have to add in a check to determine if the current program is &quot;large&quot;.
For &quot;large&quot; programs, if local storage is selected, recording will fail early.</p><h2 id="storage-system">Storage System</h2><p>Goal
: Support different DB systems</p><p><a target="_blank" rel="noopener noreferrer" href="https://www.apollographql.com/">Apollo GraphQL</a> is a graph querying interface between a client and databases or HTTP endpoints.</p><p>A Java client is <a target="_blank" rel="noopener noreferrer" href="https://www.apollographql.com/docs/android/essentials/get-started-java/">provided.</a></p><h3 id="pros">Pros</h3><ul><li>Making use of graph querying can release the amount of data kept in memory.</li><li>Finding or establishing <code>TraceNode</code> relationships can be done remotely.</li><li>Can register various different database systems (<code>mysql</code>, <code>neo4j</code>) as datasources.</li></ul><h3 id="cons">Cons</h3><ul><li>Requires the setup of an <code>Apollo Server</code>.<ul><li>This server is written in <code>javascript</code>, which introduces more technologies into this project.</li></ul></li><li>For all queries, it incurs 2 RTT network delay</li></ul><h3 id="proposal">Proposal</h3><p>The architecture diagram would look like this:</p><pre><code>@startuml
node &quot;Local Machine&quot; {
  [Microbat]
  [sqlite3]
}

cloud &quot;Container&quot; {
  [Apollo Server]
}


database &quot;Docker&quot; {
  [mysql]
  [postgresql]
}


[Microbat] -&gt; [Apollo Server]
[Apollo Server] -&gt; [sqlite3]
[Apollo Server] -&gt; [mysql]
[Apollo Server] -&gt; [postgresql]
@enduml
</code></pre><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:561px">
      <a class="gatsby-resp-image-link" style="display:block" href="/foader/foader/static/36dc8964f68bd4b2c19b57dbfb130d34/e5715/2021-08-08-20-30-29.png">
    <span class="gatsby-resp-image-background-image" style="padding-bottom:25%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA+UlEQVQY002LW2+CMACF+f8/Zw9OX7Ys24zG6ACLXJSOlnugUqBcW6rMZMtOvoeTc1Fuv5LTNA3jjBy5FOL2T3MlR/GTP/jLlcdl5Fzwtp+E4EIM48C7fkZKOS/EyEU/tKxhjNVNM5vqWrCmbbtOIYQUJL9oR3V/0DU1icMkCJGPa0q/HccCIPF8WpaUFl3D8jQ9ASOL4jrLWVkpNUlp8hmCpwK7JNgmaBVpS/NLrwI1hIvQXUX64qybBday6CWFy9Q6tFeYo+fM3Ch5mkBrB51d7HsBNKC9tcHGRxidgaG+2WCt7199D8fIsY7vzmmNoYUvpm18uLZ6B6I9ES5c5DjRAAAAAElFTkSuQmCC&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="2021 08 08 20 30 29" title="2021 08 08 20 30 29" src="/foader/static/36dc8964f68bd4b2c19b57dbfb130d34/410f3/2021-08-08-20-30-29.png" srcSet="/foader/static/36dc8964f68bd4b2c19b57dbfb130d34/0d3e1/2021-08-08-20-30-29.png 140w,/foader/static/36dc8964f68bd4b2c19b57dbfb130d34/6b1e2/2021-08-08-20-30-29.png 281w,/foader/static/36dc8964f68bd4b2c19b57dbfb130d34/410f3/2021-08-08-20-30-29.png 561w,/foader/static/36dc8964f68bd4b2c19b57dbfb130d34/e5715/2021-08-08-20-30-29.png 768w" sizes="(max-width: 561px) 100vw, 561px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
  </a>
    </span></p><p>It is possible to setup all the servers in <code>docker-compose</code>.</p><h4 id="apollo-schema">Apollo Schema</h4><p><strong>TraceNode</strong></p><pre><code class="language-js">type TraceNode {
    trace: Trace
    controlDominator: TraceNode
    stepIn: TraceNode
    stepOver: TraceNode
    invocationParent: TraceNode
    locationId: Location
    timestamp: DateTime
    read: Var
    write: Var
}
</code></pre><p><strong>Location</strong></p><pre><code class="language-js">type Location {
    line: Number
    read: Var
    write: Var
}
</code></pre><p><strong>Var</strong></p><pre><code class="language-js">type Var {
    identifier: string
    value: string (xml?)
    readBy: [TraceNode]
    writtenBy: [TraceNode]
}
</code></pre><p><strong>Trace</strong></p><pre><code class="language-js">type Trace {
    isMain: boolean
    steps: [TraceNode]
    timestamp: DateTime
}
</code></pre><p><strong>Run</strong></p><pre><code class="language-js">type Run {
    id: Number
    threads: [Trace]
    createdAt: DateTime
    projectName: string
    projectVersion: string
    launchMethod: string
    launchClass: string
}
</code></pre><h4 id="todo">TODO</h4><ul class="contains-task-list"><li class="task-list-item"><input type="checkbox" disabled=""/> <!-- -->Investigate whether translating user feedback and smart suggestion into graph queries is possible</li><li class="task-list-item"><input type="checkbox" disabled=""/> <!-- -->Investigate whether storing user feedback locally is sufficient (no need to store feedback into persistent storage)</li></ul><div class="references-block"><h3>Referred in</h3><div><div><a class="reference" href="/foader/misc/misc"><div><h5>Miscellaneous</h5></div></a></div></div></div></div><a aria-current="page" class="obstructed-label" href="/foader/misc/microbat-instrumentator-tech-spec">Microbat Tech Spec</a></div></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/misc/microbat-instrumentator-tech-spec";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-b26ca15045427b9506aa.js"],"app":["/app-27801529279600ddbc18.js"],"component---node-modules-gatsby-theme-garden-src-templates-local-file-js":["/component---node-modules-gatsby-theme-garden-src-templates-local-file-js-7cdfb5d1f36d324336f7.js"]};/*]]>*/</script><script src="/foader/polyfill-b26ca15045427b9506aa.js" nomodule=""></script><script src="/foader/webpack-runtime-c236c025df4c874ab705.js" async=""></script><script src="/foader/framework-06f646d936b841f99ebd.js" async=""></script><script src="/foader/app-27801529279600ddbc18.js" async=""></script><script src="/foader/styles-407fe62976dc5310c43e.js" async=""></script><script src="/foader/component---node-modules-gatsby-theme-garden-src-templates-local-file-js-7cdfb5d1f36d324336f7.js" async=""></script></body></html>